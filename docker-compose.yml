services:
  qdrant:
    container_name: qdrant
    image: qdrant/qdrant:latest
    ports:
      - 6333:6333
      - 6334:6334
    volumes:
      - qdrant_data:/qdrant/storage
    environment:
      - QDRANT__STORAGE__PATH=/qdrant/storage
      - QDRANT__SERVICE__GRPC_PORT=6334
      - QDRANT__SERVICE__HTTP_PORT=6333
    depends_on:
      - minio
    networks:
      - snappy-network
    restart: unless-stopped

  minio:
    container_name: minio
    image: minio/minio:latest
    ports:
      - 9000:9000
      - 9001:9001
    volumes:
      - minio_data:/data
    environment:
      - MINIO_ROOT_USER=${MINIO_ROOT_USER:-minioadmin}
      - MINIO_ROOT_PASSWORD=${MINIO_ROOT_PASSWORD:-minioadmin}
    command: server /data --console-address ":9001"
    networks:
      - snappy-network
    restart: unless-stopped

  colpali:
    container_name: colpali
    build:
      context: ./colpali
      dockerfile: Dockerfile
    image: colpali:latest
    env_file:
      - ./colpali/.env
    environment:
      - HUGGINGFACE_HUB_CACHE=/data/hf-cache
      - HF_HOME=/data/hf-cache
      - PUBLIC_HOST=${COLPALI_PUBLIC_HOST:-0.0.0.0}
      - PUBLIC_PORT=${COLPALI_PUBLIC_PORT:-7000}
    ports:
      - "${COLPALI_PUBLIC_PORT:-7000}:7000"
    volumes:
      - colpali_hf_cache:/data/hf-cache
    networks:
      snappy-network:
        aliases:
          - colpali
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
        labels: "service=colpali"
    # GPU support - gracefully ignored if no GPU available
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]

  deepseek-ocr:
    container_name: deepseek-ocr
    build:
      context: ./deepseek-ocr
      dockerfile: Dockerfile
    image: deepseek-ocr:latest
    env_file:
      - ./deepseek-ocr/.env
    environment:
      - HUGGINGFACE_HUB_CACHE=/data/hf-cache
      - HF_HOME=/data/hf-cache
    volumes:
      - deepseek_hf_cache:/data/hf-cache
    shm_size: "4g"
    ports:
      - "${DEEPSEEK_API_PORT:-8200}:${DEEPSEEK_API_PORT:-8200}"
    networks:
      snappy-network:
        aliases:
          - deepseek-ocr
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
        labels: "service=deepseek-ocr"
    # NVIDIA GPU Required - This service will not start without GPU
    # To disable on CPU-only systems: comment out this service or set DEEPSEEK_OCR_ENABLED=false in backend/.env
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]

  duckdb:
    container_name: duckdb
    build:
      context: ./duckdb
      dockerfile: Dockerfile
    image: duckdb:latest
    env_file:
      - ./duckdb/.env
    ports:
      - "${DUCKDB_API_PORT:-8300}:8300"
      - "${DUCKDB_UI_PORT:-4213}:42130"
    volumes:
      - duckdb_data:/app/data
    networks:
      snappy-network:
        aliases:
          - duckdb
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
        labels: "service=duckdb"

  backend:
    container_name: backend
    build:
      context: ./backend
      dockerfile: Dockerfile
    image: backend:latest
    env_file:
      - ./backend/.env
    environment:
      # Docker-specific overrides (use service names instead of localhost)
      - COLPALI_URL=http://colpali:7000
      - DEEPSEEK_OCR_URL=http://deepseek-ocr:8200
      - QDRANT_EMBEDDED=false
      - QDRANT_URL=http://qdrant:6333
      - MINIO_URL=http://minio:9000
      - MINIO_PUBLIC_URL=http://localhost:9000
      - DUCKDB_URL=http://duckdb:8300
    ports:
      - "8000:8000"
    volumes:
      - backend_data:/home/user/app/data
    stdin_open: true
    tty: true
    restart: unless-stopped
    depends_on:
      - qdrant
      - minio
    networks:
      - snappy-network
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
        labels: "service=backend"

  frontend:
    container_name: frontend
    build:
      context: ./frontend
      dockerfile: Dockerfile
    image: frontend:latest
    env_file:
      - ./frontend/.env
    environment:
      # Docker-specific overrides
      - API_BASE_URL_INTERNAL=http://backend:8000
      - NEXT_PUBLIC_API_BASE_URL=${NEXT_PUBLIC_API_BASE_URL:-http://localhost:8000}
      - NEXT_PUBLIC_MINIO_BASE_URL=${NEXT_PUBLIC_MINIO_BASE_URL:-http://localhost:9000}
    ports:
      - "3000:3000"
    networks:
      - snappy-network
    restart: unless-stopped
    depends_on:
      - backend
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
        labels: "service=frontend"

networks:
  snappy-network:
    driver: bridge

volumes:
  qdrant_data:
  minio_data:
  backend_data:
  duckdb_data:
  colpali_hf_cache:
  deepseek_hf_cache:
