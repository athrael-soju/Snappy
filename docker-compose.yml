x-colpali-base: &colpali-base
  container_name: colpali
  environment:
    - HUGGINGFACE_HUB_CACHE=/data/hf-cache
    - HF_HOME=/data/hf-cache
    - PUBLIC_HOST=${COLPALI_PUBLIC_HOST:-0.0.0.0}
    - PUBLIC_PORT=${COLPALI_PUBLIC_PORT:-7000}
  ports:
    - "${COLPALI_PUBLIC_PORT:-7000}:7000"
  volumes:
    - colpali_hf_cache:/data/hf-cache
  networks:
    snappy-network:
      aliases:
        - colpali
  restart: unless-stopped
  logging:
    driver: "json-file"
    options:
      max-size: "10m"
      max-file: "3"
      labels: "service=colpali"

x-deepseek-base: &deepseek-base
  container_name: deepseek-ocr
  environment:
    - MODEL_NAME=${DEEPSEEK_MODEL_NAME:-deepseek-ai/DeepSeek-OCR}
    - HUGGINGFACE_HUB_CACHE=/data/hf-cache
    - HF_HOME=/data/hf-cache
    - API_HOST=${DEEPSEEK_API_HOST:-0.0.0.0}
    - API_PORT=${DEEPSEEK_API_PORT:-8200}
    - MAX_UPLOAD_SIZE_MB=${DEEPSEEK_MAX_UPLOAD_SIZE_MB:-100}
    - DEVICE=${DEEPSEEK_DEVICE:-cuda}
    - LOG_LEVEL=${LOG_LEVEL:-INFO}
    - LOG_JSON=${LOG_JSON:-false}
  volumes:
    - deepseek_hf_cache:/data/hf-cache
  shm_size: "4g"
  ports:
    - "${DEEPSEEK_API_PORT:-8200}:${DEEPSEEK_API_PORT:-8200}"
  networks:
    snappy-network:
      aliases:
        - deepseek-ocr
  restart: unless-stopped
  logging:
    driver: "json-file"
    options:
      max-size: "10m"
      max-file: "3"
      labels: "service=deepseek-ocr"

x-qdrant-base: &qdrant-base
  container_name: qdrant
  image: qdrant/qdrant:latest
  ports:
    - 6333:6333 # HTTP API
    - 6334:6334 # gRPC API
  volumes:
    - qdrant_data:/qdrant/storage
  environment:
    - QDRANT__STORAGE__PATH=/qdrant/storage
    - QDRANT__SERVICE__GRPC_PORT=6334
    - QDRANT__SERVICE__HTTP_PORT=6333
  depends_on:
    - minio
  networks:
    - snappy-network
  restart: unless-stopped

x-minio-base: &minio-base
  container_name: minio
  image: minio/minio:latest
  ports:
    - 9000:9000
    - 9001:9001
  volumes:
    - minio_data:/data
  environment:
    - MINIO_ROOT_USER=minioadmin
    - MINIO_ROOT_PASSWORD=minioadmin
  command: server /data --console-address ":9001"
  networks:
    - snappy-network
  restart: unless-stopped

x-backend-base: &backend-base
  container_name: backend
  build:
    context: ./backend
    dockerfile: Dockerfile
  image: backend:latest
  ports:
    - "8000:8000"
  environment:
    # Application
    - LOG_LEVEL=${LOG_LEVEL:-INFO}
    - LOG_JSON=${LOG_JSON:-false}
    - LOG_FILE=
    - HOST=0.0.0.0
    - PORT=8000
    - ALLOWED_ORIGINS=${ALLOWED_ORIGINS:-*}
    # ColPali
    - COLPALI_URL=http://colpali:7000
    - COLPALI_API_TIMEOUT=${COLPALI_API_TIMEOUT:-300}
    # DeepSeek OCR
    - DEEPSEEK_OCR_ENABLED=${DEEPSEEK_OCR_ENABLED:-true}
    - DEEPSEEK_OCR_URL=http://deepseek-ocr:8200
    - DEEPSEEK_OCR_API_TIMEOUT=${DEEPSEEK_OCR_API_TIMEOUT:-180}
    - DEEPSEEK_OCR_MAX_WORKERS=${DEEPSEEK_OCR_MAX_WORKERS:-4}
    - DEEPSEEK_OCR_POOL_SIZE=${DEEPSEEK_OCR_POOL_SIZE:-20}
    - DEEPSEEK_OCR_MODE=${DEEPSEEK_OCR_MODE:-Gundam}
    - DEEPSEEK_OCR_TASK=${DEEPSEEK_OCR_TASK:-markdown}
    - DEEPSEEK_OCR_LOCATE_TEXT=${DEEPSEEK_OCR_LOCATE_TEXT:-}
    - DEEPSEEK_OCR_CUSTOM_PROMPT=${DEEPSEEK_OCR_CUSTOM_PROMPT:-}
    - DEEPSEEK_OCR_INCLUDE_GROUNDING=${DEEPSEEK_OCR_INCLUDE_GROUNDING:-true}
    - DEEPSEEK_OCR_INCLUDE_IMAGES=${DEEPSEEK_OCR_INCLUDE_IMAGES:-true}
    - DEEPSEEK_OCR_ENABLE_REGION_RELATIONS=${DEEPSEEK_OCR_ENABLE_REGION_RELATIONS:-true}
    # Processing
    - BATCH_SIZE=${BATCH_SIZE:-4}
    - ENABLE_PIPELINE_INDEXING=${ENABLE_PIPELINE_INDEXING:-true}
    # Qdrant
    - QDRANT_EMBEDDED=false
    - QDRANT_URL=http://qdrant:6333
    - QDRANT_COLLECTION_NAME=${QDRANT_COLLECTION_NAME:-documents}
    - QDRANT_SEARCH_LIMIT=${QDRANT_SEARCH_LIMIT:-20}
    - QDRANT_PREFETCH_LIMIT=${QDRANT_PREFETCH_LIMIT:-200}
    - QDRANT_ON_DISK=${QDRANT_ON_DISK:-false}
    - QDRANT_ON_DISK_PAYLOAD=${QDRANT_ON_DISK_PAYLOAD:-false}
    - QDRANT_USE_BINARY=${QDRANT_USE_BINARY:-false}
    - QDRANT_BINARY_ALWAYS_RAM=${QDRANT_BINARY_ALWAYS_RAM:-true}
    - QDRANT_SEARCH_IGNORE_QUANT=${QDRANT_SEARCH_IGNORE_QUANT:-false}
    - QDRANT_SEARCH_RESCORE=${QDRANT_SEARCH_RESCORE:-true}
    - QDRANT_SEARCH_OVERSAMPLING=${QDRANT_SEARCH_OVERSAMPLING:-2.0}
    - QDRANT_MEAN_POOLING_ENABLED=${QDRANT_MEAN_POOLING_ENABLED:-false}
    # Upload Controls
    - UPLOAD_ALLOWED_FILE_TYPES=${UPLOAD_ALLOWED_FILE_TYPES:-pdf}
    - UPLOAD_MAX_FILE_SIZE_MB=${UPLOAD_MAX_FILE_SIZE_MB:-10}
    - UPLOAD_MAX_FILES=${UPLOAD_MAX_FILES:-5}
    - UPLOAD_CHUNK_SIZE_BYTES=${UPLOAD_CHUNK_SIZE_BYTES:-4194304}
    # MinIO
    - MINIO_URL=http://minio:9000
    - MINIO_PUBLIC_URL=http://localhost:9000
    - MINIO_ACCESS_KEY=minioadmin
    - MINIO_SECRET_KEY=minioadmin
    - MINIO_BUCKET_NAME=${MINIO_BUCKET_NAME:-documents}
    - MINIO_WORKERS=${MINIO_WORKERS:-12}
    - MINIO_RETRIES=${MINIO_RETRIES:-3}
    - MINIO_FAIL_FAST=${MINIO_FAIL_FAST:-false}
    - MINIO_PUBLIC_READ=${MINIO_PUBLIC_READ:-true}
    - IMAGE_FORMAT=${IMAGE_FORMAT:-JPEG}
    - IMAGE_QUALITY=${IMAGE_QUALITY:-75}
    # DuckDB
    - DUCKDB_ENABLED=${DUCKDB_ENABLED:-false}
    - DUCKDB_URL=http://duckdb:8300
    - DUCKDB_DATABASE_NAME=${DUCKDB_DATABASE_NAME:-documents}
    - DUCKDB_API_TIMEOUT=${DUCKDB_API_TIMEOUT:-30}
    - DUCKDB_BATCH_SIZE=${DUCKDB_BATCH_SIZE:-10}
    - DUCKDB_RETRY_ATTEMPTS=${DUCKDB_RETRY_ATTEMPTS:-3}
    - DUCKDB_CALCULATE_REGION_RELATIONSHIPS=${DUCKDB_CALCULATE_REGION_RELATIONSHIPS:-true}
    - DUCKDB_MERGE_CROSS_PAGE_REGIONS=${DUCKDB_MERGE_CROSS_PAGE_REGIONS:-true}
    # MUVERA
    - MUVERA_ENABLED=${MUVERA_ENABLED:-false}
    - MUVERA_K_SIM=${MUVERA_K_SIM:-6}
    - MUVERA_DIM_PROJ=${MUVERA_DIM_PROJ:-32}
    - MUVERA_R_REPS=${MUVERA_R_REPS:-20}
    - MUVERA_RANDOM_SEED=${MUVERA_RANDOM_SEED:-42}
  volumes:
    - backend_data:/home/user/app/data
  stdin_open: true
  tty: true
  restart: unless-stopped
  depends_on:
    - qdrant
    - minio
  networks:
    - snappy-network
  logging:
    driver: "json-file"
    options:
      max-size: "10m"
      max-file: "3"
      labels: "service=backend"

x-frontend-base: &frontend-base
  container_name: frontend
  build:
    context: ./frontend
    dockerfile: Dockerfile
  image: frontend:latest
  ports:
    - "3000:3000"
  environment:
    - NEXT_PUBLIC_API_BASE_URL=${NEXT_PUBLIC_API_BASE_URL:-http://localhost:8000}
    - NEXT_PUBLIC_MINIO_BASE_URL=${NEXT_PUBLIC_MINIO_BASE_URL:-http://localhost:9000}
    - PUBLIC_MINIO_URL_SET=true
    - OPENAI_API_KEY=${OPENAI_API_KEY}
    - OPENAI_MODEL=${OPENAI_MODEL:-gpt-5-nano}
    - OPENAI_TEMPERATURE=${OPENAI_TEMPERATURE:-1}
  networks:
    - snappy-network
  restart: unless-stopped
  depends_on:
    - backend
  logging:
    driver: "json-file"
    options:
      max-size: "10m"
      max-file: "3"
      labels: "service=frontend"

x-duckdb-base: &duckdb-base
  container_name: duckdb
  build:
    context: ./duckdb
    dockerfile: Dockerfile
  image: duckdb:latest
  ports:
    - "${DUCKDB_API_PORT:-8300}:8300"
    - "${DUCKDB_UI_PORT:-4213}:42130"
  volumes:
    - duckdb_data:/app/data
  environment:
    - DUCKDB_DATABASE_PATH=/app/data/ocr_data.duckdb
    - DUCKDB_API_HOST=0.0.0.0
    - DUCKDB_API_PORT=8300
    - LOG_LEVEL=${LOG_LEVEL:-INFO}
  networks:
    snappy-network:
      aliases:
        - duckdb
  restart: unless-stopped
  logging:
    driver: "json-file"
    options:
      max-size: "10m"
      max-file: "3"
      labels: "service=duckdb"

services:
  qdrant:
    profiles:
      - cpu
      - gpu
    <<: *qdrant-base

  minio:
    profiles:
      - cpu
      - gpu
    <<: *minio-base

  colpali-cpu:
    <<: *colpali-base
    profiles:
      - cpu
    image: colpali:cpu
    build:
      context: ./colpali
      dockerfile: Dockerfile.cpu

  colpali-gpu:
    <<: *colpali-base
    profiles:
      - gpu
    image: colpali:gpu
    build:
      context: ./colpali
      dockerfile: Dockerfile.gpu
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: ${COLPALI_GPU_COUNT:-all}
              capabilities:
                - gpu

  deepseek-ocr-gpu:
    <<: *deepseek-base
    profiles:
      - gpu
    image: deepseek-ocr:gpu
    build:
      context: ./deepseek-ocr
      dockerfile: Dockerfile
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: ${DEEPSEEK_GPU_COUNT:-all}
              capabilities:
                - gpu

  duckdb:
    profiles:
      - cpu
      - gpu
    <<: *duckdb-base

  backend:
    profiles:
      - cpu
      - gpu
    <<: *backend-base

  frontend:
    profiles:
      - cpu
      - gpu
    <<: *frontend-base

networks:
  snappy-network:
    driver: bridge

volumes:
  qdrant_data:
  minio_data:
  backend_data:
  colpali_hf_cache:
  deepseek_hf_cache:
  duckdb_data:
