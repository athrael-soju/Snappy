volumes:
  hf-cache: {}

x-api-common: &api-common
  environment:
    - HUGGINGFACE_HUB_CACHE=/data/hf-cache
    - HF_HOME=/data/hf-cache
    - PUBLIC_HOST=${PUBLIC_HOST:-localhost}
    - PUBLIC_PORT=${PUBLIC_PORT:-7000}
  volumes:
    - hf-cache:/data/hf-cache
  ports:
    - "${PUBLIC_PORT:-7000}:7000"
  restart: unless-stopped

services:
  api-cpu:
    <<: *api-common
    profiles: ["cpu"]
    build:
      context: .
      dockerfile: Dockerfile.cpu
    container_name: colmodernvbert-api-cpu

  api-gpu:
    <<: *api-common
    profiles: ["gpu"]
    build:
      context: .
      dockerfile: Dockerfile.gpu
    container_name: colmodernvbert-api-gpu
    gpus: "${COLPALI_GPUS:-all}"
